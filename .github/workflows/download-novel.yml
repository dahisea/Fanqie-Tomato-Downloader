name: å¢å¼ºç‰ˆç•ªèŒ„å°è¯´ä¸‹è½½å™¨

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
    inputs:
      novel_id:
        description: 'å°è¯´ID (ä»ç•ªèŒ„å°è¯´URLä¸­è·å–)'
        required: true
      threads:
        description: 'ä¸‹è½½çº¿ç¨‹æ•° (1-10)'
        required: true
        default: '4'
      format:
        description: 'è¾“å‡ºæ ¼å¼'
        required: true
        type: choice
        options:
          - txt
          - epub
        default: 'txt'
      start_chapter:
        description: 'èµ·å§‹ç« èŠ‚ (å¯é€‰ï¼Œä»1å¼€å§‹)'
        required: false
        default: ''
      end_chapter:
        description: 'ç»“æŸç« èŠ‚ (å¯é€‰ï¼ŒåŒ…å«)'
        required: false
        default: ''
      use_enhanced_api:
        description: 'ä½¿ç”¨å¢å¼ºAPIè·å–è¯¦ç»†ä¿¡æ¯'
        required: false
        type: boolean
        default: true

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: read  # å…è®¸è¯»å–ä»“åº“å†…å®¹
  actions: write  # å…è®¸ä¸Šä¼ æ„å»ºäº§ç‰©

jobs:
  download-novel:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev python3-pip
          
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 fake-useragent ebooklib
          
      - name: åˆ›å»ºå¿…è¦æ–‡ä»¶
        run: |
          # åˆ›å»ºcookie.jsonæ–‡ä»¶
          if [ ! -f "./cookie.json" ]; then
            echo '""' > "./cookie.json"
          fi
          
          # åˆ›å»ºconfig.pyé…ç½®æ–‡ä»¶
          cat > config.py << 'EOF'
          """é…ç½®æ–‡ä»¶"""
          import os

          CONFIG = {
              "max_workers": int(os.environ.get("THREADS", "4")),
              "request_timeout": 15,
              "status_file": "chapter.json",
              "auth_token": "wcnmd91jb",
              "server_url": "https://dlbkltos.s7123.xyz:5080/api/sources",
              "api_endpoints": [],
              "batch_config": {
                  "enabled": False
              }
          }

          class Config:
              @staticmethod
              def get(key, default=None):
                  return CONFIG.get(key, default)
          EOF
          
          # åˆ›å»ºç®€åŒ–çš„æ¨¡å—åŒ–ç»„ä»¶
          cat > network.py << 'EOF'
          """ç½‘ç»œç®¡ç†æ¨¡å—"""
          class NetworkManager:
              pass
          EOF
          
          cat > content_processor.py << 'EOF'
          """å†…å®¹å¤„ç†æ¨¡å—"""
          class ContentProcessor:
              pass
          EOF
          
          cat > download_engine.py << 'EOF'
          """ä¸‹è½½å¼•æ“æ¨¡å—"""
          class DownloadEngine:
              pass
          EOF
          
          cat > file_output.py << 'EOF'
          """æ–‡ä»¶è¾“å‡ºæ¨¡å—"""
          class FileOutputManager:
              pass
          EOF
          
          cat > state_manager.py << 'EOF'
          """çŠ¶æ€ç®¡ç†æ¨¡å—"""
          class StateManager:
              pass
          EOF
          
      - name: å‡†å¤‡å¢å¼ºç‰ˆä¸‹è½½è„šæœ¬
        run: |
          cat > enhanced_download.py << 'EOF'
          import sys
          import os
          import time

          def run_enhanced_download():
              # å¯¼å…¥å¢å¼ºç‰ˆä¸‹è½½å™¨
              from enhanced_novel_downloader import EnhancedNovelDownloader
              
              # è·å–å‚æ•°
              novel_id = sys.argv[1]
              output_format = sys.argv[2].lower()
              threads = int(sys.argv[3])
              start_chapter_str = sys.argv[4] if len(sys.argv) > 4 else ""
              end_chapter_str = sys.argv[5] if len(sys.argv) > 5 else ""
              
              save_path = "novel_output"
              os.makedirs(save_path, exist_ok=True)
              
              # å¤„ç†ç« èŠ‚èŒƒå›´
              start_chapter = None
              end_chapter = None
              if start_chapter_str and end_chapter_str:
                  try:
                      start_chapter = int(start_chapter_str) - 1  # è½¬æ¢ä¸º0åŸºç´¢å¼•
                      end_chapter = int(end_chapter_str) - 1
                      print(f"æŒ‡å®šç« èŠ‚èŒƒå›´: {start_chapter_str}-{end_chapter_str}")
                  except ValueError:
                      print("ç« èŠ‚èŒƒå›´å‚æ•°æ— æ•ˆï¼Œå°†ä¸‹è½½å…¨éƒ¨ç« èŠ‚")
              
              # è®¾ç½®çº¿ç¨‹æ•°
              from config import CONFIG
              CONFIG["max_workers"] = threads
              
              # åˆå§‹åŒ–ä¸‹è½½å™¨
              downloader = EnhancedNovelDownloader()
              
              def progress_callback(progress, message):
                  if progress >= 0:
                      print(f"è¿›åº¦: {progress:.1f}% - {message}")
                  else:
                      print(message)
              
              downloader.progress_callback = progress_callback
              
              print(f"å¼€å§‹ä¸‹è½½å°è¯´ ID: {novel_id}")
              print(f"ä¿å­˜è·¯å¾„: {save_path}")
              print(f"ä½¿ç”¨çº¿ç¨‹æ•°: {threads}")
              print(f"è¾“å‡ºæ ¼å¼: {output_format}")
              
              try:
                  # è¿è¡Œä¸‹è½½
                  downloader.run_download(novel_id, save_path, output_format, start_chapter, end_chapter)
                  print("âœ… ä¸‹è½½å®Œæˆï¼")
                  
                  # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
                  print("\nğŸ“š ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:")
                  for file in os.listdir(save_path):
                      file_path = os.path.join(save_path, file)
                      if os.path.isfile(file_path):
                          file_size = os.path.getsize(file_path) / 1024  # KB
                          print(f"  ğŸ“„ {file} ({file_size:.2f} KB)")
                          
              except Exception as e:
                  print(f"âŒ ä¸‹è½½å¤±è´¥: {str(e)}")
                  sys.exit(1)

          if __name__ == "__main__":
              run_enhanced_download()
          EOF
          
          # é‡å‘½å2.pyä¸ºenhanced_novel_downloader.pyä»¥ä¾¿å¯¼å…¥
          cp 2.py enhanced_novel_downloader.py
          
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "THREADS=${{ github.event.inputs.threads }}" >> $GITHUB_ENV
          
      - name: æ‰§è¡Œå¢å¼ºç‰ˆä¸‹è½½
        run: |
          echo "ğŸš€ å¯åŠ¨å¢å¼ºç‰ˆç•ªèŒ„å°è¯´ä¸‹è½½å™¨..."
          
          # æ„å»ºå‚æ•°
          ARGS="${{ github.event.inputs.novel_id }} ${{ github.event.inputs.format }} ${{ github.event.inputs.threads }}"
          
          # æ·»åŠ ç« èŠ‚èŒƒå›´å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
          if [ -n "${{ github.event.inputs.start_chapter }}" ] && [ -n "${{ github.event.inputs.end_chapter }}" ]; then
            ARGS="$ARGS ${{ github.event.inputs.start_chapter }} ${{ github.event.inputs.end_chapter }}"
          fi
          
          echo "å‚æ•°: $ARGS"
          python enhanced_download.py $ARGS
          
      - name: éªŒè¯ä¸‹è½½ç»“æœ
        run: |
          if [ -d "novel_output" ] && [ "$(ls -A novel_output)" ]; then
            echo "âœ… ä¸‹è½½æ–‡ä»¶éªŒè¯æˆåŠŸ"
            echo "æ–‡ä»¶è¯¦æƒ…:"
            ls -la novel_output/
            
            # æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼ˆä»…æ˜¾ç¤ºå‰å‡ è¡Œï¼‰
            echo -e "\nğŸ“– æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            for file in novel_output/*; do
              if [ -f "$file" ]; then
                echo "--- $(basename "$file") ---"
                head -n 5 "$file"
                echo "..."
                echo ""
              fi
            done
          else
            echo "âŒ ä¸‹è½½éªŒè¯å¤±è´¥ï¼šè¾“å‡ºç›®å½•ä¸ºç©º"
            exit 1
          fi
          
      - name: å‹ç¼©ä¸‹è½½ç»“æœ
        run: |
          cd novel_output
          
          # æ ¹æ®æ–‡ä»¶æ•°é‡é€‰æ‹©å‹ç¼©æ–¹å¼
          file_count=$(ls -1 | wc -l)
          
          if [ $file_count -eq 1 ]; then
            # å•æ–‡ä»¶ç›´æ¥é‡å‘½å
            file_name=$(ls -1)
            cp "$file_name" "../novel_${{ github.event.inputs.novel_id }}.${{ github.event.inputs.format }}"
            echo "å•æ–‡ä»¶è¾“å‡º: novel_${{ github.event.inputs.novel_id }}.${{ github.event.inputs.format }}"
          else
            # å¤šæ–‡ä»¶å‹ç¼©
            zip -r "../novel_files_${{ github.event.inputs.novel_id }}.zip" *
            echo "å¤šæ–‡ä»¶å‹ç¼©: novel_files_${{ github.event.inputs.novel_id }}.zip"
          fi
          
      - name: ä¸Šä¼ å•æ–‡ä»¶ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: novel-${{ github.event.inputs.novel_id }}-${{ github.event.inputs.format }}
          path: |
            novel_${{ github.event.inputs.novel_id }}.${{ github.event.inputs.format }}
            novel_files_${{ github.event.inputs.novel_id }}.zip
          retention-days: 7
          if-no-files-found: ignore
          
      - name: ä¸Šä¼ å®Œæ•´è¾“å‡ºç›®å½•
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: complete-output-${{ github.event.inputs.novel_id }}
          path: novel_output/
          retention-days: 3
          if-no-files-found: ignore
          
      - name: ç”Ÿæˆä¸‹è½½æŠ¥å‘Š
        if: always()
        run: |
          echo "# ğŸ“– ç•ªèŒ„å°è¯´ä¸‹è½½æŠ¥å‘Š" > download_report.md
          echo "" >> download_report.md
          echo "## ğŸ“‹ ä¸‹è½½ä¿¡æ¯" >> download_report.md
          echo "- **å°è¯´ID**: ${{ github.event.inputs.novel_id }}" >> download_report.md
          echo "- **è¾“å‡ºæ ¼å¼**: ${{ github.event.inputs.format }}" >> download_report.md
          echo "- **çº¿ç¨‹æ•°**: ${{ github.event.inputs.threads }}" >> download_report.md
          
          if [ -n "${{ github.event.inputs.start_chapter }}" ] && [ -n "${{ github.event.inputs.end_chapter }}" ]; then
            echo "- **ç« èŠ‚èŒƒå›´**: ${{ github.event.inputs.start_chapter }}-${{ github.event.inputs.end_chapter }}" >> download_report.md
          else
            echo "- **ç« èŠ‚èŒƒå›´**: å…¨éƒ¨ç« èŠ‚" >> download_report.md
          fi
          
          echo "- **ä¸‹è½½æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> download_report.md
          echo "" >> download_report.md
          
          if [ -d "novel_output" ] && [ "$(ls -A novel_output)" ]; then
            echo "## âœ… ä¸‹è½½æˆåŠŸ" >> download_report.md
            echo "" >> download_report.md
            echo "### ğŸ“ è¾“å‡ºæ–‡ä»¶" >> download_report.md
            
            for file in novel_output/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                filesize=$(du -h "$file" | cut -f1)
                echo "- **$filename** ($filesize)" >> download_report.md
              fi
            done
            
          else
            echo "## âŒ ä¸‹è½½å¤±è´¥" >> download_report.md
            echo "è¯·æ£€æŸ¥å°è¯´IDæ˜¯å¦æ­£ç¡®ï¼Œæˆ–æŸ¥çœ‹è¿è¡Œæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> download_report.md
          fi
          
          echo "" >> download_report.md
          echo "## ğŸ“¥ å¦‚ä½•ä¸‹è½½" >> download_report.md
          echo "1. ç‚¹å‡»é¡µé¢ä¸Šæ–¹çš„ **Summary** æ ‡ç­¾" >> download_report.md
          echo "2. åœ¨ **Artifacts** éƒ¨åˆ†æ‰¾åˆ°ä¸‹è½½æ–‡ä»¶" >> download_report.md
          echo "3. ç‚¹å‡»å¯¹åº”æ–‡ä»¶è¿›è¡Œä¸‹è½½" >> download_report.md
          echo "" >> download_report.md
          echo "ğŸ’¡ **æç¤º**: æ–‡ä»¶å°†ä¿å­˜7å¤©ï¼Œè¯·åŠæ—¶ä¸‹è½½ä¿å­˜ã€‚" >> download_report.md
          
          # æ˜¾ç¤ºæŠ¥å‘Šå†…å®¹
          echo "ğŸ“Š ç”Ÿæˆçš„ä¸‹è½½æŠ¥å‘Š:"
          cat download_report.md
          
      - name: ä¸Šä¼ ä¸‹è½½æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: download-report-${{ github.event.inputs.novel_id }}
          path: download_report.md
          retention-days: 7
          
      - name: æä¾›ä¸‹è½½æŒ‡å¼•
        if: always()
        run: |
          echo ""
          echo "ğŸ‰====================================ğŸ‰"
          echo "           ç•ªèŒ„å°è¯´ä¸‹è½½å®Œæˆ"
          echo "ğŸ‰====================================ğŸ‰"
          echo ""
          if [ -d "novel_output" ] && [ "$(ls -A novel_output)" ]; then
            echo "âœ… å°è¯´ä¸‹è½½æˆåŠŸï¼"
            echo ""
            echo "ğŸ“¥ ä¸‹è½½æ–¹å¼ï¼š"
            echo "1. ç‚¹å‡»é¡µé¢é¡¶éƒ¨çš„ 'Summary' æ ‡ç­¾"
            echo "2. åœ¨ 'Artifacts' éƒ¨åˆ†æ‰¾åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š"
            echo "   ğŸ“š novel-${{ github.event.inputs.novel_id }}-${{ github.event.inputs.format }} (ä¸»è¦æ–‡ä»¶)"
            echo "   ğŸ“Š download-report-${{ github.event.inputs.novel_id }} (ä¸‹è½½æŠ¥å‘Š)"
            echo "   ğŸ“ complete-output-${{ github.event.inputs.novel_id }} (å®Œæ•´è¾“å‡º)"
            echo ""
            echo "â° æ–‡ä»¶ä¿å­˜æœŸé™ï¼š"
            echo "   - å°è¯´æ–‡ä»¶å’ŒæŠ¥å‘Šï¼š7å¤©"
            echo "   - å®Œæ•´è¾“å‡ºï¼š3å¤©"
            echo ""
            echo "ğŸ’¡ å»ºè®®ä¼˜å…ˆä¸‹è½½ä¸»è¦æ–‡ä»¶ï¼ŒåŒ…å«å®Œæ•´çš„å°è¯´å†…å®¹ã€‚"
          else
            echo "âŒ ä¸‹è½½è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜"
            echo "è¯·æ£€æŸ¥ï¼š"
            echo "1. å°è¯´IDæ˜¯å¦æ­£ç¡®"
            echo "2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
            echo "3. æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          fi
          echo ""
